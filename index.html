<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>YouthBeat</title>
  <meta name="description" content="YouthBeat">
  <meta name="author" content="The Royal Conservatory">

  <!-- <link rel="stylesheet" href="css/styles.css?v=1.0"> -->

  <script src="https://unpkg.com/konva@3.3.3/konva.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/13.0.1/Tone.min.js"></script>
</head>

<body>
  <div id="container"></div>
  <script type="text/javascript">

Tone.Transport.bpm.value = 90;
Tone.Transport.loop = true;
Tone.Transport.loopStart = "0";
Tone.Transport.loopEnd = "2m";

var bdsdPatterns = [
  "01-BDSD.wav",
  "02-BDSD.wav",
  "03-BDSD.wav",
  "04-BDSD.wav",
  "05-BDSD.wav",
  "06-BDSD.wav",
  "07-BDSD.wav",
  "08-BDSD.wav",
  "09-BDSD.wav",
  "10-BDSD.wav",
  "11-BDSD.wav",
  "12-BDSD.wav",
  "13-BDSD.wav",
  "14-BDSD.wav",
  "15-BDSD.wav",
  "16-BDSD.wav",
  "17-BDSD.wav",
  "18-BDSD.wav",
  "19-BDSD.wav",
  "20-BDSD.wav",
  "21-BDSD.wav",
  "22-BDSD.wav",
  "23-BDSD.wav",
  "24-BDSD.wav"];

var bdsdURLs = bdsdPatterns.map(fileName => "Sounds/Rhythm/Kit_1/BDSD_90bpm/" + fileName)

// var bdsdPlayer = new Tone.Player({url: bdsdURLs[0], loop:true}).toMaster().sync().start(0)
var bdsdPlayers = new Tone.Players(bdsdURLs).toMaster()

for(var playerName in bdsdURLs) {
    var player = bdsdPlayers.get(playerName)
    player.loop = true
    player.mute = true
    player.sync().start()
  }

Tone.Buffer.on('load', function(){
	console.log("all buffers loaded")
})

  // first we need to create a stage
var stage = new Konva.Stage({
  container: 'container',   // id of container <div>
  width: 500,
  height: 500
});

// then create layer
var layer = new Konva.Layer();
var bdsdCircles = drawCircles(bdsdPlayers, bdsdURLs);
// var hhCircles = drawCircles();


function drawCircles(players, loopUrls) { 
  var circleGroup = new Konva.Group()

  var spacing = 6
  var radius = 22
  var x = 0 + spacing / 2 + radius
  var y = 0 + spacing / 2 + radius

  var index = 0
  for (i = 0; i < 3; i++) {
    y = 0 + spacing / 2 + radius;
    for (j = 0; j < 8; j++ ) {
      var circle = new Konva.Circle({
        x: x,
        y: y,
        radius: radius,
        fill: 'red',
        id: index
      });  
      layer.add(circle);

      var text = new Konva.Text({
        x: x - radius,
        y: y - radius,
        text: index + 1,
        fontSize: 12,
        fill: 'white',
        width: radius * 2,
        height: radius *2,
        align: 'center',
        verticalAlign: 'middle'
      });
      circleGroup.add(circle)
      circleGroup.add(text);

      // var clickFunction = loopFunction(index)
      // text.on('click', function(e) { 
      //   clickFunction(circleGroup, players, loopUrls);
      // });
    
    var test = loopFunction.bind(this, index)
    text.on('click', function() {
        test()
      })

      y += spacing + radius * 2
      index++;
    }
    x += spacing + radius * 2;
  }

  return circleGroup
}

function loopFunction(i) {
  console.log("loop function: ", i);
}

function loopFunction2(i) {
  console.log("loop function", i);
  return function(buttons, players, loopUrls) {
    console.log("index:\t", i);
    console.log("buttons:\t", buttons);
    console.log("players:\t", players);
    console.log("loopUrls:\t", loopUrls);
    triggerLoop(i, buttons, players, loopUrls)
  };
}

function triggerLoop(index, buttons, players, loopUrls) {
  console.log("triggerLoop " + index);
  selectButton(index, buttons);
  toggleLoop(index, players, loopUrls);
}

function selectButton(index, buttons) {
  console.log("selectLoop " + index);

  var nodes = layer.find('Circle')
  nodes.forEach(node => {
    node.fill(node.id() == index ? 'green' : 'red');
    // console.log(node.id(), node.fill())
    layer.draw()
  })

  toggleLoop(index)
  
}

var toggle = false

function toggleLoop(index, players, loopUrls) {
  console.log("toggleLoop", index, players, loopUrls)
  Tone.context.resume()

  if (toggle) {
    players.stopAll()
    toggle = false
    return;  
  }

  for(var playerName in loopUrls) {
    var player = players.get(playerName)
    // console.log(playerName, index, playerName == index, player.mute)
    player.mute = playerName != index
  }

  if (Tone.Transport.state != "started") {
   Tone.Transport.start()
  }

  // toggle = true
}


layer.add(bdsdCircles);
stage.add(layer);
// layer.draw();
  </script>
</body>
</html>