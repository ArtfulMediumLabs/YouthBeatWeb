<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>YouthBeat</title>
  <meta name="description" content="YouthBeat">
  <meta name="author" content="The Royal Conservatory">

  <!-- <link rel="stylesheet" href="css/styles.css?v=1.0"> -->

  <script src="https://unpkg.com/konva@3.3.3/konva.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/13.0.1/Tone.min.js"></script>
</head>

<body>
  <div id="container"></div>
  <script type="text/javascript">

Tone.Transport.bpm.value = 90;
Tone.Transport.loop = true;
Tone.Transport.loopStart = "0";
Tone.Transport.loopEnd = "2m";

var bdsdPatterns = [
  "01-BDSD.wav",
  "02-BDSD.wav",
  "03-BDSD.wav",
  "04-BDSD.wav",
  "05-BDSD.wav",
  "06-BDSD.wav",
  "07-BDSD.wav",
  "08-BDSD.wav",
  "09-BDSD.wav",
  "10-BDSD.wav",
  "11-BDSD.wav",
  "12-BDSD.wav",
  "13-BDSD.wav",
  "14-BDSD.wav",
  "15-BDSD.wav",
  "16-BDSD.wav",
  "17-BDSD.wav",
  "18-BDSD.wav",
  "19-BDSD.wav",
  "20-BDSD.wav",
  "21-BDSD.wav",
  "22-BDSD.wav",
  "23-BDSD.wav",
  "24-BDSD.wav"];

var hhPatterns = [
  "01-Hihat.wav",
  "02-Hihat.wav",
  "03-Hihat.wav",
  "04-Hihat.wav",
  "05-Hihat.wav",
  "06-Hihat.wav",
  "07-Hihat.wav",
  "08-Hihat.wav",
  "09-Hihat.wav",
  "10-Hihat.wav",
  "11-Hihat.wav",
  "12-Hihat.wav",
  "13-Hihat.wav",
  "14-Hihat.wav",
  "15-Hihat.wav",
  "16-Hihat.wav",
  "17-Hihat.wav",
  "18-Hihat.wav",
  "19-Hihat.wav",
  "20-Hihat.wav",
  "21-Hihat.wav",
  "22-Hihat.wav",
  "23-Hihat.wav",
  "24-Hihat.wav"];

var fills = [
  "Heavy 10.4_90_1beats FIX C6.wav",
  "Heavy 10.3_90_1beats FIX C#6.wav",
  "Heavy 10.2_90_2beats FIX D6.wav",
  "Heavy 10.1_90_2beats FIX D#6.wav",
  "Dez.4_90 C5.wav",
  "Dez.3_90 C#5.wav",
  "Dez.2_90 D5.wav",
  "Dez.1_90 D#5.wav",
  "Dez 2.4_90 E5.wav",
  "Dez 2.3_90 F5.wav",
  "Dez 2.2_90 F#5.wav",
  "Dez 2.1_90 G5.wav",
  "Big.1_90 C7.wav",
  "Big.2_90 C#7.wav",
  "Big.3_90 D7.wav",
  "Big.4_90 D#7.wav",
  "Big.4_90 D#7.wav"];

var bdsdURLs = bdsdPatterns.map(fileName => "Sounds/Rhythm/Kit_1/BDSD_90bpm/" + fileName)
var hhURLs = hhPatterns.map(fileName => "Sounds/Rhythm/Kit_1/Hihat_90bpm/" + fileName)
var fillURLs = fills.map(fileName => "Sounds/BeatsPalette90/" + encodeURIComponent(fileName))

var bdsdPlayers = createPlayers(bdsdURLs)
var hhPlayers = createPlayers(hhURLs)
var fillPlayers = createOneShots(fillURLs)

function createPlayers(URLs) { 
  var players = new Tone.Players(URLs).toMaster()
  for(var playerName in URLs) {
    var player = players.get(playerName)
    player.loop = true
    player.mute = true
    player.sync().start()
  }
  return players
}

function createOneShots(URLs) {
  return new Tone.Players(URLs).toMaster()
}

var buffersLoaded = false
var imagesLoaded = false

Tone.Buffer.on('load', function(){
	console.log("all buffers loaded")
  buffersLoaded = true
  updateLoading()
})

  // first we need to create a stage
var stage = new Konva.Stage({
  container: 'container',   // id of container <div>
  width: 1028,
  height: 768 - 200
});

var layer = new Konva.Layer();

var loadingText = new Konva.Text({
        x: stage.width() / 2,
        y: stage.height() / 2,
        text: 'Loading...',
        fontSize: 30,
        fill: 'black'
      });
layer.add(loadingText)

function updateLoading() {
  loadingText.visible(buffersLoaded && imagesLoaded)
  layer.batchDraw();
}

// then create layer
var spacing = 6
var radius = 22
var segmentWidth = spacing * 2 + radius * 2 * 3
var hhOriginX = stage.width() - segmentWidth

var fillSpacing = 8
var fillDiameter = 44
var fillWidth = 4 * fillDiameter + 3 * spacing
var doubleFillHeight = 2 * fillDiameter + spacing
var centeredFillHeight = doubleFillHeight / 2 + fillDiameter/2
var stageThird = stage.width() / 5

var bdsdCircles = drawCircles(0, 0, bdsdPlayers, bdsdURLs, '#F9BAF9', '#C687C6');
var hhCircles = drawCircles(hhOriginX, 0, hhPlayers, hhURLs, '#9ECCEF', '#6B99BC');

var fillCirclesA = drawFillCircles(stageThird - fillWidth / 2, stage.height() - centeredFillHeight, 0, 4, fillPlayers)
var fillCirclesB = drawFillCircles(stageThird * 2.5 - fillWidth / 2, stage.height() - doubleFillHeight, 4, 4, fillPlayers)
var fillCirclesC = drawFillCircles(stageThird * 2.5 - fillWidth / 2, stage.height() - fillDiameter, 8, 4, fillPlayers)
var fillCirclesD = drawFillCircles(stageThird * 4 - fillWidth / 2, stage.height() - centeredFillHeight, 12, 4, fillPlayers)

function drawFillCircles(originX, originY, start, count, players) {
  var spacing = 8
  var diameter = 44
      var imageObj = new Image();
      imageObj.onload = function() {
        for (i = start; i < (start + count); i++) {
          var lonestar = new Konva.Image({
            x: originX + (diameter + spacing) * (i - start),
            y: originY,
            image: imageObj,
            width: 44,
            height: 44
          });
          console.log(lonestar.x())
          lonestar.on('click', oneShotFunction(i, players))

          // add the shape to the layer
          layer.add(lonestar);
        }
        layer.batchDraw();
        imagesLoaded = true;
        updateLoading()
      };
      imageObj.src = 'img/lonestar-2.png';

}

function oneShotFunction(i, players) {
  return function() {
    triggerOneShot(i, players)
  };
}

function triggerOneShot(index, players) {
  console.log("triggerOneShot " + index);
 Tone.context.resume()

  var player = players.get(index)
  console.log(player)
  player.start()
}

function drawCircles(originX, originY, players, loopUrls, fillColor, activeColor) { 
  var circleGroup = new Konva.Group()

  var spacing = 6
  var radius = 22
  var x = originX + radius //+ spacing / 2 + radius
  var y = originY + radius //+ spacing / 2 + radius

  var index = 0
  var test = []
  for (i = 0; i < 3; i++) {
    y = originY + radius //+ spacing / 2 + radius;
    for (j = 0; j < 8; j++ ) {
      var circle = new Konva.Circle({
        x: x,
        y: y,
        radius: radius,
        fill: fillColor,
        id: index
      });  
      layer.add(circle);

      var text = new Konva.Text({
        x: x - radius,
        y: y - radius,
        text: index + 1,
        fontSize: 12,
        fill: 'grey',
        width: radius * 2,
        height: radius *2,
        align: 'center',
        verticalAlign: 'middle',
        id: index
      });
      circleGroup.add(circle)
      circleGroup.add(text);

      text.on('click', loopFunction(index, circleGroup, players, loopUrls, fillColor, activeColor));

      y += spacing + radius * 2
      index++;
    }
    x += spacing + radius * 2;
  }

  return circleGroup
}

function loopFunction(i, buttonGroup, players, loopUrls, fillColor, activeColor) {
  return function() {
    console.log("index:\t", i);
    console.log("buttonGroup:\t", buttonGroup);
    console.log("players:\t", players);
    console.log("loopUrls:\t", loopUrls);
    console.log("fillColor:\t", fillColor);
    console.log("activeColor:\t", activeColor);
    triggerLoop(i, buttonGroup, players, loopUrls, fillColor, activeColor)
  };
}

function triggerLoop(index, buttonGroup, players, loopUrls, fillColor, activeColor) {
  console.log("triggerLoop " + index);
  toggleLoop(index, players, loopUrls);
  selectButton(buttonGroup, players, fillColor, activeColor);
}

function selectButton(buttonGroup, players, fillColor, activeColor) {
  console.log("selectButton");

  var nodes = buttonGroup.find('Circle')
  nodes.forEach(node => {
    var index = node.id()
    node.fill(!players.get(index).mute ? activeColor : fillColor);
  })
  nodes = buttonGroup.find('Text')
  nodes.forEach(node => {
    var index = node.id()
    node.fill(!players.get(index).mute ? 'white' : 'grey');
  })
  layer.batchDraw();
}

function toggleLoop(index, players, loopUrls) {
  console.log("toggleLoop", index, players, loopUrls)
  Tone.context.resume()

  if (false) {
    players.stopAll()
    return;  
  }

  for(var playerName in loopUrls) {
    var player = players.get(playerName)
    // console.log(playerName, index, playerName == index, player.mute)
    if (playerName == index) {
      if (player.mute) {
        player.mute = false
        if (Tone.Transport.state != "started") {
          Tone.Transport.start()
        }
      } else {
        player.mute = true
      }
    } else {
      player.mute = true
    }
    
  }
}

function autoStopTransport() {
  if (!someLoop()) {
    Tone.Transport.stop()
  }
}

function someLoop() {
  for(var playerName in bdsdURLs) {
    var player = bdsdPlayers.get(playerName)
    if (!player.mute) {
      return true
    }
  }
  for(var playerName in hhURLs) {
    var player = hhPlayers.get(playerName)
    if (!player.mute) {
      return true
    }
  }
  return false
}

layer.add(bdsdCircles);
layer.add(hhCircles);
stage.add(layer);
// layer.draw();
  </script>
</body>
</html>